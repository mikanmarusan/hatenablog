# PHP7.2 から導入された パスワードハッシュ関数のハッシュアルゴリズム Argon2 を使ってみた


### 概要
2017/11/30にPHP7.2がリリースされた。 [PHP5.5.0 から導入されたパスワードハッシュ関数を使ってみた](http://mikanmarusan.hatenablog.com/entry/2014/02/01/174207) の更新から3年。PHP7.2でハッシュアルゴリズム Argon2 が追加されたので調べてみた。

### tl;dr
- パスワードハッシュ関数(password_*)のハッシュアルゴリズムに Argon2 が追加
- PHP7.2ではデフォルトのハッシュアルゴリズムに変更なし（bcyrptのまま）

###  Argon2

Argon2は、2015年のPassword Hashing Competition(https://password-hashing.net/)のWinnerになったパスワードハッシュアルゴリズムで、[クリエイティブ・コモンズのCC0 と Apache 2.0 のデュアルライセンスで公開](https://github.com/p-h-c/phc-winner-argon2)されている。

で、論文がこれ。
[Argon2: the memory-hard function for password hashing and other
applications](https://password-hashing.net/argon2-specs.pdf)

実際には Argon2dとArgon2iという2つのアルゴリズムで構成されているが、password_* のアルゴリズムとして採用されているのはArgon2iの方。Argon2iはサイドチャネル攻撃（side-channel timing attacks）耐性があり、Argon2dはGPUを使った攻撃に対する耐性がある。

ハッシュアルゴリズムが使うメモリコスト（メモリ使用量）と時間コスト（回数）と並列度（ハッシュ化時に利用するCPUスレッドの数）をパラメータとして設定し、サーバーサイドアプリケーションの負荷に応じてハッシュ強度を設定できるアルゴリズムのようだ。そのパラメータの設定値は定数として定義されていて

```php
# Argon2で定義されている定数を覗いてみる
<?php
        # メモリコスト（メモリ使用量; 単位 KiB）
        echo PASSWORD_ARGON2_DEFAULT_MEMORY_COST . PHP_EOL;
        # 時間コスト（回数）
        echo PASSWORD_ARGON2_DEFAULT_TIME_COST   . PHP_EOL;
        # 並列度（CPUスレッド数）
        echo PASSWORD_ARGON2_DEFAULT_THREADS     . PHP_EOL;
```

```shell
# 実行結果
1024
2
2
```

な感じ。

### API一覧

APIについては password_* が公開されたPHP5.5から大きく変更されていない。
したがってArgon2の利用方法と注意点だけをかいつまんで説明することにする。

#### password_hash

まずはハッシュ生成関数。

```php
string password_hash ( string $password , integer $algo [, array $options ] )
```

第1引数 ```$password``` は生パスワード、第2引数 ```$algo``` はハッシュアルゴリズム定数、第3引数は ```$options``` アルゴリズムがサポートするオプションを入力する。ハッシュアルゴリズムをArgon2をするだけであれば、```$algo```に PASSWORD_ARGON2I を指定するだけでよい。

```php
<?php
    $raw_passwd = '3kanmarusan_Passw0rd';

    $hashed_passwd = password_hash($raw_passwd, PASSWORD_ARGON2I);
```

```shell
# 実行結果
hash:$argon2i$v=19$m=1024,t=2,p=2$SEJ2M2VNL3B5MXZNN0tDYg$44a3kX0OxiFzoy4bCtkHnAyy7/TVkvIVU7kdyj8ewCg
```
$argon2iで始まっているので、Argon2っぽい。$m=1024,t=2,p=2がハッシュ化時に使用しているパラメータ。これはPHPで定義されたデフォルト値そのものである（前述）。パラメータは連想配列で指定することができる。

```php
<?php
    $hashed_passwd = password_hash($raw_passwd, PASSWORD_ARGON2I, ['memory_cost' => 4096, 'time_cost' => 8, 'threads' => 4]);
```

```shell
# 実行結果
hash:$argon2i$v=19$m=4096,t=8,p=4$ejcvNmtJL3J1R2kwQWRkVA$Z1QBd6MShZmK+hIGGXfOQx1tq1djPjt8yJC1RDh//6Y
```

生成されたパスワードハッシュにも $m=4096,t=8,p=4 とあるので指定通りになっている。

ちなみに、ハッシュアルゴリズムのデフォルト（PASSWORD_DEFAULT）に変更があるか調べたところ、PHP7.2の段階では変更がないようだ。

```php
# PASSWORD_DEFAULTはまだbcryptということを調べる
<?php
  echo "[constants]" . PHP_EOL;
  echo " PASSWORD_BCYRPT: "  . PASSWORD_BCRYPT  . PHP_EOL;
  echo " PASSWORD_ARGON2I: "  . PASSWORD_ARGON2I  . PHP_EOL;
  echo " PASSWORD_DEFAULT: " . PASSWORD_DEFAULT . PHP_EOL;
```

```shell
# 実行結果
[constants]
 PASSWORD_BCYRPT: 1
 PASSWORD_ARGON2I: 2
 PASSWORD_DEFAULT: 1
```

PHP [RFCのプロセス](https://wiki.php.net/rfc/argon2_password_hash#resolved_inclusion_on_74)によれば、PHP7.4でハッシュアルゴリズムのデフォルトをArgon2に変更しようとする提案があったようが、今回のRFCでは取り下げられたようだ。

> [Resolved] Inclusion on 7.4
> Per discussion on the internals mailing list during an initial vote, this RFC no longer proposes changes to PASSWORD_DEFAULT in 7.4.

### password_get_info

先ほどの説明の通り、password_hashは、アルゴリズムやコスト、ソルトといった情報もハッシュに含めて返す。password_get_infoは、password_hashで生成した有効なハッシュを第1引数```$hash```で渡すと、ハッシュに関する情報の配列を返すメソッド。bcryptの時とインタフェースに変更はないが、戻り値の options が少し変わる。

```php
array password_get_info ( string $hash )
```

先ほどArgon2で生成したハッシュ $argon2i$v=19$m=4096,t=8,p=4$ejcvNmtJL3J1R2kwQWRkVA$Z1QBd6MShZmK+hIGGXfOQx1tq1djPjt8yJC1RDh//6Y について確認してみる。

```php
<?php
        # password_hash で生成した有効なハッシュ(Algon2) 
        $hash = '$argon2i$v=19$m=4096,t=8,p=4$ejcvNmtJL3J1R2kwQWRkVA$Z1QBd6MShZmK+hIGGXfOQx1tq1djPjt8yJC1RDh//6Y';
        $info = password_get_info($hash);
        print_r($info);
```

```shell
Array
(
    [algo] => 2
    [algoName] => argon2i
    [options] => Array
        (
            [memory_cost] => 4096
            [time_cost] => 8
            [threads] => 4
        )
)
```

```algo``` の値が、PASSWORD_ARGON2I(=2) を指しており、```options``` にハッシュ化時に使用したパラメータが表示されていることがわかる。

#### PASSWORD_DEFAULT と PASSWORD_BCRYPT の使い分け

[password_hash](http://www.php.net/manual/ja/function.password-hash.php) には下記のことが書かれている。

>* PASSWORD_DEFAULT - bcrypt アルゴリズムを使います (PHP 5.5.0 の時点でのデフォルトです)。 __新しくてより強力なアルゴリズムが PHP に追加されれば、 この定数もそれにあわせて変わっていきます。 そのため、これを指定したときの結果の長さは、変わる可能性があります。 したがって、結果をデータベースに格納するときにはカラム幅を 60 文字以上にできるようなカラムを使うことをお勧めします (255 文字くらいが適切でしょう)__。  
>* PASSWORD_BCRYPT - CRYPT_BLOWFISH アルゴリズムを使ってハッシュを作ります。これは標準の crypt() 互換のハッシュで、識別子 "$2y$" を使った場合の結果を作ります。 その結果は、常に 60 文字の文字列になります。失敗した場合に FALSE を返します。

こう書かれると、メンテナンスコストも考えると PASSWORD_DEFAULT を選ぶのが怖い気もするけれども、マニュアルの下の方にアルゴリズムの更新/追加/デフォルト化のリリースルールが書かれている。 

>__注意__: この関数がサポートするアルゴリズムの更新 (あるいはデフォルトのアルゴリズムの変更) は、必ず次の手順にのっとって行われます。
>
>* 新しく追加されたアルゴリズムがデフォルトになるまでには、 少なくとも一度は PHP のフルリリースを経ること。 つまり、たとえば、新しいアルゴリズムが 5.5.5 で追加されたとすると、 そのアルゴリズムがデフォルトになるのは早くても 5.7 以降ということになります (5.6 は、最初のフルリリースだからです)。 しかし、もし別のアルゴリズムが 5.6.0 で追加されたとすると、 そのアルゴリズムも 5.7.0 の時点でデフォルトになる資格を得ます。
>* デフォルトを変更できるのはフルリリース (5.6.0 や 6.0.0 など) のときだけで、リビジョンリリースでは変更できない。 唯一の例外は、現在のデフォルトにセキュリティ上の致命的な欠陥が発覚した場合の緊急リリースです。

先週(2014/1/23)、PHP5.6.0alpha1がリリースされたけれども、

* パスワードハッシュAPIには大きな変更が無さそうなのでデフォルトが変更されるのはもう少し時間がかかりそう
 * このまま行けばPHP5.6ではアルゴリズム変更は無いので、少なくとも次のフルリリースとなる（であろう）PHP5.7を経て、PHP5.8まで変更はないと期待できる
* パスワードハッシュAPIのアルゴリズム更新ルールが明確
* （後述しますが）パスワードハッシュそのものにアルゴリズムやコスト、ソルトなどが含まれており、異なるハッシュアルゴリズムが混在していもパスワードの検証は出来る。

を考えると、PASSWORD_DEFAULT でもあまり問題にならないのではないかと思っている（個人の見解です）。 

とはいえ、アルゴリズムはどんどん強固なものに更新していく必要もあり、それをサポートする後述の機能(password_needs_rehash)も提供されていることを考慮すれば、少なくともハッシュをデータベース等のストレージに格納する場合は、カラム長にゆとりを持たせておくことは大事ですね（玉虫色の回答）。


#### password_verify

ここは変更なし

### password_needs_rehash を使ってパスワードハッシュアルゴリズムをアップデートする

パスワードをハッシュで保存しているときに、パスワードハッシュの強度（アルゴリズムやコスト、ソルトやストレッチングの回数など）を変更したい場合がある。PHP7.1まではアルゴリズムが bcrypt のみだったのでコストやソルトの変更しかできなかったが、PHP7.2からはアルゴリズムが追加されたのでハッシュアルゴリズムが変更できるか試してみる。

なお、ハッシュで保存している=生パスワードを知り得ないので、ハッシュ強度の変更をオフラインで実行することはできない。したがって、ユーザーの認証が成功した時に（生のパスワードが分かっているので）オンラインでハッシュの変更(rehash)をする。

下記は、bcryptアルゴリズムでハッシュ化されて保存されているパスワードハッシュに対して、認証成功後にArgon2アルゴリズムで再ハッシュする疑似コードである。

```php
<?php
        $raw_passwd = '3kanmarusan_Passw0rd'; // ユーザーの入力
        $hashed_passwd = '$2y$10$fAO/bg1Ti9.yBM3wC3FyJeIfrIql9dVFx/dhTDZO.FjSSjylRRCLK'; // DBなどから引っ張ってきたもの（これはbcrypyでハッシュ化されている）

        // まず認証しようず！
        if(password_verify($raw_passwd, $hashed_passwd)) {
                // パスワード認証成功。
                if(password_needs_rehash($hashed_passwd, PASSWORD_ARGON2I)) {
                        // rehashが必要
                        $new_hashed_passwd = password_hash($raw_passwd, PASSWORD_ARGON2I);

                        // (新しいハッシュをDBに格納)
                        // ...
                }
        } else {
        // パスワード認証失敗
    　}
```

### tl;dr
- パスワードハッシュ関数(password_*)のハッシュアルゴリズムに Argon2 が追加
- PHP7.2ではデフォルトのハッシュアルゴリズムに変更なし（bcyrptのまま）
